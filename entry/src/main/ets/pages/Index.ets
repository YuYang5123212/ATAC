import { BluetoothManager, ScannedDevice } from '../utils/BluetoothManager';
import { PermissionManager } from '../utils/PermissionManager';
// å¼•å…¥ LogItem (æ³¨æ„è·¯å¾„è¦å¯¹ï¼Œå¦‚æžœæŠ¥é”™è¯·ç¡®è®¤ LogPage.ets çš„ä½ç½®)
// è¿™é‡Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿ï¼Œç›´æŽ¥åœ¨ä¸‹é¢é‡æ–°å®šä¹‰æŽ¥å£ç»“æž„ï¼Œæˆ–è€…åˆ©ç”¨ Storage ç›´æŽ¥æ“ä½œ
import { promptAction } from '@kit.ArkUI';
import type common from '@ohos.app.ability.common';

// åˆå§‹åŒ–æŒä¹…åŒ–å­˜å‚¨
PersistentStorage.persistProp('HistoryDevices', []);
PersistentStorage.persistProp('AppLogs', []); // ç¡®ä¿æ—¥å¿—å­˜å‚¨å·²åˆå§‹åŒ–

interface SavedDevice {
  deviceId: string;
  deviceName: string;
}

// ç®€å•çš„æ—¥å¿—ç»“æž„å®šä¹‰ (ä¸Ž LogPage ä¿æŒä¸€è‡´)
interface LogItem {
  timestamp: string;
  deviceName: string;
  content: string;
  type: 'SEND' | 'RECV';
}

@Component
struct DeviceItem {
  device: ScannedDevice = { deviceId: '', deviceName: '', rssi: 0 };
  isHistory: boolean = false;
  btManager: BluetoothManager | null = null;
  onConnectSuccess: (device: ScannedDevice) => void = (device: ScannedDevice) => {};

  // ã€æ–°å¢žã€‘çˆ¶ç»„ä»¶ä¼ å…¥çš„å†™æ—¥å¿—æ–¹æ³•
  onAddLog: (text: string, type: 'SEND' | 'RECV') => void = () => {};

  @StorageLink('ConnectedIDs') connectedIDs: string[] = [];
  @State isConnecting: boolean = false;

  @State doorState: number = 0;
  @State lastMessage: string = '';

  build() {
    Column() {
      Row() {
        Column() {
          Row() {
            Text(this.device.deviceName || "æœªçŸ¥è®¾å¤‡")
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.isConnected() ? '#007DFF' : '#333333')

            if (this.isConnected()) {
              if (this.doorState === 1) {
                Text(" [ðŸ”“]")
                  .fontSize(14)
                  .fontColor('#4CAF50')
                  .fontWeight(FontWeight.Bold)
              } else if (this.doorState === 2) {
                Text(" [ðŸ”’]")
                  .fontSize(14)
                  .fontColor('#FF5252')
                  .fontWeight(FontWeight.Bold)
              }
            }
          }

          Text(this.device.deviceId)
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Button(this.getButtonText())
          .height(30)
          .fontSize(12)
          .backgroundColor(this.getButtonColor())
          .enabled(!this.isConnecting)
          .onClick(async () => {
            this.handleButtonClick();
          })
          .animation({ duration: 300 })
      }
      .width('100%')

      if (this.isConnected()) {
        Column() {
          Divider().color('#F0F0F0').margin({ top: 10, bottom: 10 })

          Row() {
            Text("RX: " + (this.lastMessage || "ç­‰å¾…æ•°æ®..."))
              .fontSize(12)
              .fontColor('#666666')
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .maxLines(1)
          }
          .width('100%')
          .padding({ left: 5, bottom: 10 })

          Row({ space: 15 }) {
            Button("å¼€ é—¨")
              .type(ButtonType.Normal)
              .borderRadius(8)
              .backgroundColor('#4CAF50')
              .fontColor(Color.White)
              .layoutWeight(1)
              .height(40)
              .onClick(() => {
                this.btManager?.sendCommand(this.device.deviceId, "1");
                // ã€åŸ‹ç‚¹ã€‘è®°å½•æ—¥å¿—
                this.onAddLog("å‘é€å¼€é—¨æŒ‡ä»¤", 'SEND');
              })

            Button("å…³ é—¨")
              .type(ButtonType.Normal)
              .borderRadius(8)
              .backgroundColor('#FF5252')
              .fontColor(Color.White)
              .layoutWeight(1)
              .height(40)
              .onClick(() => {
                this.btManager?.sendCommand(this.device.deviceId, "0");
                this.onAddLog("å‘é€å…³é—¨æŒ‡ä»¤", 'SEND');
              })

            Button("æŸ¥ è¯¢")
              .type(ButtonType.Normal)
              .borderRadius(8)
              .backgroundColor('#FF9800')
              .fontColor(Color.White)
              .layoutWeight(1)
              .height(40)
              .onClick(() => {
                this.btManager?.sendCommand(this.device.deviceId, "?");
                this.onAddLog("æŸ¥è¯¢çŠ¶æ€", 'SEND');
              })
          }
          .width('100%')
        }
        .transition({ type: TransitionType.All, opacity: 0, translate: { y: -10 } })
      }
    }
    .width('100%')
    .padding(15)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 10 })
    .shadow({ radius: 4, color: '#1A000000', offsetY: 2 })
    .animation({ duration: 300 })
  }

  isConnected(): boolean {
    return this.connectedIDs.includes(this.device.deviceId);
  }

  getButtonText(): string {
    if (this.isConnecting) return "è¿žæŽ¥ä¸­...";
    if (this.isConnected()) return "æ–­ å¼€";
    return "è¿ž æŽ¥";
  }

  getButtonColor(): ResourceColor {
    if (this.isConnecting) return '#CCCCCC';
    if (this.isConnected()) return '#E91E63';
    return '#007DFF';
  }

  async handleButtonClick() {
    if (!this.btManager) return;

    if (this.isConnected()) {
      this.btManager.close(this.device.deviceId);
      this.doorState = 0;
      this.lastMessage = '';
      return;
    }

    this.isConnecting = true;
    let success = await this.btManager.connect(this.device.deviceId);
    this.isConnecting = false;

    if (success) {
      this.onConnectSuccess(this.device);
      this.onAddLog("è¿žæŽ¥æˆåŠŸ", 'RECV');

      this.btManager.setOnDataReceived(this.device.deviceId, (data: string) => {
        let cleanData = data.trim();
        this.lastMessage = cleanData;

        // ã€åŸ‹ç‚¹ã€‘æ”¶åˆ°æ¶ˆæ¯è®°å½•æ—¥å¿—
        this.onAddLog(cleanData, 'RECV');

        if (cleanData.includes("OPEN")) {
          this.doorState = 1;
        } else if (cleanData.includes("CLOSE")) {
          this.doorState = 2;
        }
      });

      setTimeout(() => {
        this.btManager?.sendCommand(this.device.deviceId, "?");
      }, 3000);
    }
  }
}

@Component
export struct IndexPage {
  @StorageLink('HistoryDevices') historyDevices: SavedDevice[] = [];
  @State newDevices: ScannedDevice[] = [];

  // ç»‘å®šå…¨å±€æ—¥å¿—
  @StorageLink('AppLogs') appLogs: LogItem[] = [];

  private btManager = new BluetoothManager();
  private context = getContext(this) as common.UIAbilityContext;
  private scanTimer: number = -1;

  async aboutToAppear() {
    let granted = await PermissionManager.requestBluetoothPermission(this.context);
    if (granted) {
      this.refreshScan();
    }
  }

  onPageShow() {
    this.startScanLoop();
  }

  onPageHide() {
    this.stopScanLoop();
  }

  // ã€æ–°å¢žã€‘æ·»åŠ æ—¥å¿—çš„è¾…åŠ©å‡½æ•°
  addLog(deviceName: string, content: string, type: 'SEND' | 'RECV') {
    // èŽ·å–å½“å‰æ—¶é—´ HH:mm:ss
    let now = new Date();
    let timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

    let newItem: LogItem = {
      timestamp: timeStr,
      deviceName: deviceName,
      content: content,
      type: type
    };

    // æ’å…¥åˆ°æœ€å‰é¢
    this.appLogs.unshift(newItem);

    // é™åˆ¶æ—¥å¿—æ¡æ•°ï¼Œé˜²æ­¢æ— é™å¢žé•¿ (ä¿ç•™æœ€è¿‘100æ¡)
    if (this.appLogs.length > 100) {
      this.appLogs = this.appLogs.slice(0, 100);
    }
  }

  startScanLoop() {
    this.stopScanLoop();
    this.refreshScan();
    this.scanTimer = setInterval(() => {
      this.refreshScan();
    }, 5000);
  }

  stopScanLoop() {
    if (this.scanTimer !== -1) {
      clearInterval(this.scanTimer);
      this.scanTimer = -1;
    }
    this.btManager.stopScan();
  }

  refreshScan() {
    this.newDevices = [];
    this.btManager.startScan((device: ScannedDevice) => {
      let isHistory = this.historyDevices.some((d: SavedDevice) => d.deviceId === device.deviceId);
      if (!isHistory) {
        let exists = this.newDevices.some((d: ScannedDevice) => d.deviceId === device.deviceId);
        if (!exists) {
          this.newDevices.push(device);
        }
      }
    });
  }

  handleConnectSuccess(device: ScannedDevice) {
    let newHistory = this.historyDevices.filter((d: SavedDevice) => d.deviceId !== device.deviceId);
    newHistory.unshift({ deviceId: device.deviceId, deviceName: device.deviceName });
    this.historyDevices = newHistory;
    this.newDevices = this.newDevices.filter((d: ScannedDevice) => d.deviceId !== device.deviceId);
  }

  build() {
    Column() {
      Text("ATæ™ºèƒ½é—¨ç¦")
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .width('100%')
        .padding({ left: 20, top: 20, bottom: 10 })

      List() {
        if (this.historyDevices.length > 0) {
          ListItem() {
            Text("å·²é…å¯¹è®¾å¤‡")
              .fontSize(14)
              .fontColor('#666666')
              .margin({ bottom: 8, left: 5 })
          }

          ForEach(this.historyDevices, (item: SavedDevice) => {
            ListItem() {
              DeviceItem({
                device: { deviceId: item.deviceId, deviceName: item.deviceName, rssi: 0 },
                isHistory: true,
                btManager: this.btManager,
                onConnectSuccess: (d: ScannedDevice): void => this.handleConnectSuccess(d),
                // ã€æ ¸å¿ƒã€‘å°† addLog å‡½æ•°ä¼ ç»™å­ç»„ä»¶ä½¿ç”¨
                onAddLog: (text, type) => {
                  this.addLog(item.deviceName || "æœªçŸ¥", text, type);
                }
              })
            }
          })
        }

        ListItem() {
          Row() {
            Text("æ–°å‘çŽ°è®¾å¤‡")
              .fontSize(14)
              .fontColor('#666666')
            Blank()
            Text("åˆ·æ–°")
              .fontSize(14)
              .fontColor('#007DFF')
              .onClick(() => { this.refreshScan() })
          }
          .width('100%')
          .padding({ left: 5, right: 5, top: 10, bottom: 8 })
        }

        if (this.newDevices.length === 0) {
          ListItem() {
            Text("æ­£åœ¨æ‰«æé™„è¿‘è®¾å¤‡...")
              .fontSize(14)
              .fontColor('#999999')
              .width('100%')
              .textAlign(TextAlign.Center)
              .padding(20)
          }
        }

        ForEach(this.newDevices, (item: ScannedDevice) => {
          ListItem() {
            DeviceItem({
              device: item,
              isHistory: false,
              btManager: this.btManager,
              onConnectSuccess: (d: ScannedDevice): void => this.handleConnectSuccess(d),
              // ã€æ ¸å¿ƒã€‘ä¼ é€’æ—¥å¿—å›žè°ƒ
              onAddLog: (text, type) => {
                this.addLog(item.deviceName || "æœªçŸ¥", text, type);
              }
            })
          }
        })
      }
      .layoutWeight(1)
      .width('100%')
      .padding({ left: 15, right: 15 })
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F3F5')
  }
}
import { router, promptAction } from '@kit.ArkUI';

// ã€å…³é”®ä¿®å¤ã€‘å®šä¹‰æŽ¥å£
interface SavedDevice {
  deviceId: string;
  deviceName: string;
}

@CustomDialog
struct DeviceManageDialog {
  controller: CustomDialogController;
  // ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨æŽ¥å£ç±»åž‹
  @StorageLink('HistoryDevices') historyDevices: SavedDevice[] = [];

  build() {
    Column() {
      Text("å·²é…å¯¹è®¾å¤‡ç®¡ç†")
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 10 })

      List() {
        // ã€å…³é”®ä¿®å¤ã€‘ForEach ç±»åž‹å£°æ˜Ž
        ForEach(this.historyDevices, (item: SavedDevice, index: number) => {
          ListItem() {
            Row() {
              Column() {
                Text(item.deviceName || "æœªçŸ¥è®¾å¤‡")
                  .fontSize(16)
                  .fontColor('#333333')
                Text(item.deviceId)
                  .fontSize(12)
                  .fontColor('#999999')
              }
              .alignItems(HorizontalAlign.Start)

              Blank()

              Button("åˆ é™¤")
                .height(28)
                .fontSize(12)
                .backgroundColor('#FF5252')
                .onClick(() => {
                  this.historyDevices.splice(index, 1);
                  try { promptAction.showToast({ message: 'å·²å–æ¶ˆé…å¯¹' }); } catch(e) {}

                  if (this.historyDevices.length === 0) {
                    this.controller.close();
                  }
                })
            }
            .width('100%')
            .padding({ left: 15, right: 15, top: 10, bottom: 10 })
            .border({ width: { bottom: 1 }, color: '#F5F5F5' })
          }
        })
      }
      .width('100%')
      .height(this.historyDevices.length > 5 ? 300 : 'auto')
      .constraintSize({ minHeight: 100 })

      Button("å…³ é—­")
        .width('90%')
        .margin({ top: 10, bottom: 20 })
        .backgroundColor('#F2F3F5')
        .fontColor('#666666')
        .onClick(() => {
          this.controller.close();
        })
    }
    .backgroundColor(Color.White)
    .borderRadius(16)
    .width('90%')
  }
}

@Component
export struct MyPage {
  // ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨æŽ¥å£ç±»åž‹
  @StorageLink('HistoryDevices') historyDevices: SavedDevice[] = [];

  dialogController: CustomDialogController = new CustomDialogController({
    builder: DeviceManageDialog(),
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  build() {
    Column() {
      // --- å¤´éƒ¨ ---
      Column() {
        // å¤´åƒå ä½
        Text('ðŸ‘¤')
          .fontSize(40)
          .width(80)
          .height(80)
          .textAlign(TextAlign.Center)
          .backgroundColor('#E0E0E0')
          .borderRadius(40)
          .margin({ bottom: 10 })

        Text("ç®¡ç†å‘˜")
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Text("ID: 88888888")
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 5 })
      }
      .width('100%')
      .padding({ top: 50, bottom: 30 })
      .backgroundColor(Color.White)

      // --- èœå• ---
      Column({ space: 15 }) {

        this.MenuButton(
          "ç®¡ç†å·²é…å¯¹è®¾å¤‡",
          "æŸ¥çœ‹æˆ–ç§»é™¤å·²è¿žæŽ¥è¿‡çš„è“ç‰™é”",
          '#007DFF',
          () => {
            if (this.historyDevices.length === 0) {
              try { promptAction.showToast({ message: 'æš‚æ— é…å¯¹è®¾å¤‡' }); } catch(e) {}
            } else {
              this.dialogController.open();
            }
          }
        )

        this.MenuButton(
          "é—¨ç¦å¡è®¾ç½®",
          "æŸ¥çœ‹å„è®¾å¤‡çš„æŽˆæƒå¡ç‰‡ä¿¡æ¯",
          '#FF9800',
          () => {
            try {
              router.pushUrl({ url: 'pages/CardManagePage' });
            } catch (err) {
              console.error(`è·³è½¬å¤±è´¥: ${JSON.stringify(err)}`);
            }
          }
        )

        this.MenuButton(
          "é€€å‡ºç™»å½•",
          "è¿”å›žç™»å½•é¡µé¢",
          '#FF5252',
          () => {
            try { router.replaceUrl({ url: 'pages/LoginPage' }); } catch(e) {}
          }
        )

      }
      .width('100%')
      .layoutWeight(1)
      .padding(20)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F3F5')
  }

  @Builder
  MenuButton(title: string, subtitle: string, color: string, onClick: () => void) {
    Button() {
      Row() {
        Column()
          .width(4)
          .height(40)
          .backgroundColor(color)
          .borderRadius(2)
          .margin({ right: 15 })

        Column() {
          Text(title)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text(subtitle)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Text(">")
          .fontSize(16)
          .fontColor('#CCCCCC')
      }
      .width('100%')
      .padding(15)
    }
    .type(ButtonType.Normal)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(onClick)
    .shadow({ radius: 4, color: '#0D000000', offsetY: 2 })
  }
}
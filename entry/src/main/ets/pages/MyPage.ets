import { router, promptAction } from '@kit.ArkUI';

// å®šä¹‰æŽ¥å£
interface SavedDevice {
  deviceId: string;
  deviceName: string;
}

@CustomDialog
struct DeviceManageDialog {
  controller: CustomDialogController;
  @StorageLink('HistoryDevices') historyDevices: SavedDevice[] = [];

  build() {
    Column() {
      Text("å·²é…å¯¹è®¾å¤‡ç®¡ç†")
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 10 })

      List() {
        ForEach(this.historyDevices, (item: SavedDevice, index: number) => {
          ListItem() {
            Row() {
              Column() {
                Text(item.deviceName || "æœªçŸ¥è®¾å¤‡")
                  .fontSize(16)
                  .fontColor('#333333')
                Text(item.deviceId)
                  .fontSize(12)
                  .fontColor('#999999')
              }
              .alignItems(HorizontalAlign.Start)

              Blank()

              Button("åˆ é™¤")
                .height(28)
                .fontSize(12)
                .backgroundColor('#FF5252')
                .onClick(() => {
                  this.historyDevices.splice(index, 1);
                  try { promptAction.showToast({ message: 'å·²å–æ¶ˆé…å¯¹' }); } catch(e) {}

                  if (this.historyDevices.length === 0) {
                    this.controller.close();
                  }
                })
            }
            .width('100%')
            .padding({ left: 15, right: 15, top: 10, bottom: 10 })
            .border({ width: { bottom: 1 }, color: '#F5F5F5' })
          }
        })
      }
      .width('100%')
      .height(this.historyDevices.length > 5 ? 300 : 'auto')
      .constraintSize({ minHeight: 100 })

      Button("å…³ é—­")
        .width('90%')
        .margin({ top: 10, bottom: 20 })
        .backgroundColor('#F2F3F5')
        .fontColor('#666666')
        .onClick(() => {
          this.controller.close();
        })
    }
    .backgroundColor(Color.White)
    .borderRadius(16)
    .width('90%')
  }
}

@Component
export struct MyPage {
  @StorageLink('HistoryDevices') historyDevices: SavedDevice[] = [];

  // å®šä¹‰å½“å‰ç”¨æˆ·åï¼Œæ–¹ä¾¿å¼¹çª—è°ƒç”¨
  private userName: string = "ç®¡ç†å‘˜";

  dialogController: CustomDialogController = new CustomDialogController({
    builder: DeviceManageDialog(),
    autoCancel: true,
    alignment: DialogAlignment.Center
  });

  build() {
    Column() {
      // --- 1. å¤´éƒ¨ä¸ªäººä¿¡æ¯ ---
      Column() {
        Text('ðŸ‘¤')
          .fontSize(40)
          .width(80)
          .height(80)
          .textAlign(TextAlign.Center)
          .backgroundColor('#E0E0E0')
          .borderRadius(40)
          .margin({ bottom: 10 })

        Text(this.userName)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Text("ID: 88888888")
          .fontSize(14)
          .fontColor('#999999')
          .margin({ top: 5 })
      }
      .width('100%')
      .padding({ top: 50, bottom: 30 })
      .backgroundColor(Color.White)

      // --- 2. åŠŸèƒ½èœå•åŒº (å æ®ä¸­é—´å‰©ä½™ç©ºé—´) ---
      Column({ space: 15 }) {

        this.MenuButton(
          "ç®¡ç†å·²é…å¯¹è®¾å¤‡",
          "æŸ¥çœ‹æˆ–ç§»é™¤å·²è¿žæŽ¥è¿‡çš„è“ç‰™é”",
          '#007DFF',
          () => {
            if (this.historyDevices.length === 0) {
              try { promptAction.showToast({ message: 'æš‚æ— é…å¯¹è®¾å¤‡' }); } catch(e) {}
            } else {
              this.dialogController.open();
            }
          }
        )

        this.MenuButton(
          "é—¨ç¦å¡è®¾ç½®",
          "æŸ¥çœ‹å„è®¾å¤‡çš„æŽˆæƒå¡ç‰‡ä¿¡æ¯",
          '#FF9800',
          () => {
            try {
              router.pushUrl({ url: 'pages/CardManagePage' });
            } catch (err) {
              console.error(`è·³è½¬å¤±è´¥: ${JSON.stringify(err)}`);
            }
          }
        )
      }
      .width('100%')
      .layoutWeight(1) // ã€å…³é”®ã€‘è®©èœå•åŒºæ’‘å¼€ï¼ŒæŠŠé€€å‡ºæŒ‰é’®æŒ¤åˆ°åº•éƒ¨
      .padding(20)

      // --- 3. åº•éƒ¨é€€å‡ºæŒ‰é’® ---
      Button("é€€å‡ºç™»å½•")
        .type(ButtonType.Capsule) // åœ†è§’çŸ©å½¢
        .width('85%')
        .height(50)
        .backgroundColor('#FF5252') // çº¢è‰²
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 40 }) // åº•éƒ¨ç•™ç™½ï¼Œç•¥å¾®åä¸Š
        .shadow({ radius: 10, color: '#4DFF5252', offsetY: 5 }) // æ·»åŠ é˜´å½±å¢žåŠ å±‚æ¬¡æ„Ÿ
        .onClick(() => {
          // å¼¹çª—ç¡®è®¤
          AlertDialog.show({
            title: 'æç¤º',
            message: `æ˜¯å¦ç¡®è®¤é€€å‡ºå½“å‰å¸å·â€œ${this.userName}â€ï¼Ÿ`,
            autoCancel: true,
            alignment: DialogAlignment.Center,
            primaryButton: {
              value: 'å–æ¶ˆ',
              fontColor: '#666666',
              action: () => {
                // å–æ¶ˆæ“ä½œï¼Œä»€ä¹ˆéƒ½ä¸åš
              }
            },
            secondaryButton: {
              value: 'ç¡®è®¤é€€å‡º',
              fontColor: '#FF5252',
              action: () => {
                // ç¡®è®¤é€€å‡ºï¼Œè·³è½¬å›žç™»å½•é¡µ
                try {
                  router.replaceUrl({ url: 'pages/LoginPage' });
                } catch(e) {}
              }
            }
          });
        })

    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F2F3F5')
  }

  @Builder
  MenuButton(title: string, subtitle: string, color: string, onClick: () => void) {
    Button() {
      Row() {
        Column()
          .width(4)
          .height(40)
          .backgroundColor(color)
          .borderRadius(2)
          .margin({ right: 15 })

        Column() {
          Text(title)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          Text(subtitle)
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        Text(">")
          .fontSize(16)
          .fontColor('#CCCCCC')
      }
      .width('100%')
      .padding(15)
    }
    .type(ButtonType.Normal)
    .backgroundColor(Color.White)
    .borderRadius(12)
    .onClick(onClick)
    .shadow({ radius: 4, color: '#0D000000', offsetY: 2 })
  }
}
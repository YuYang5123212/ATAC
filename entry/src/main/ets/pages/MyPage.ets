import { router, promptAction } from '@kit.ArkUI';
// 1. è®°å¾—å¼•å…¥å·¥å…·ç±» (æ³¨æ„è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼Œæ ¹æ®ä½  utils æ–‡ä»¶å¤¹çš„ä½ç½®)
import { PreferencesUtil } from '../utils/PreferencesUtil';

interface SavedDevice {
  deviceId: string;
  deviceName: string;
}

// --- é€€å‡ºç™»å½•å¼¹çª— ---
@CustomDialog
struct LogoutDialog {
  controller: CustomDialogController;
  confirmAction: () => void = () => {};
  userName: string = "";

  build() {
    Column() {
      Text("æç¤º").fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White).margin({ top: 20, bottom: 10 })
      Text(`æ˜¯å¦ç¡®è®¤é€€å‡ºå½“å‰å¸å·â€œ${this.userName}â€ï¼Ÿ`).fontSize(14).fontColor('#AAAAAA').margin({ bottom: 20 }).padding({ left: 20, right: 20 }).textAlign(TextAlign.Center)

      Row() {
        Button("å–æ¶ˆ").onClick(() => this.controller.close()).backgroundColor(Color.Transparent).fontColor('#AAAAAA').layoutWeight(1)

        Button("ç¡®è®¤é€€å‡º")
          .onClick(async () => { // æ³¨æ„è¿™é‡ŒåŠ äº† async
            // æ‰§è¡Œä¼ å…¥çš„ç¡®è®¤é€»è¾‘
            this.confirmAction();
            this.controller.close();
          })
          .backgroundColor(Color.Transparent).fontColor('#FF5252').layoutWeight(1)
      }
      .margin({ top: 10, bottom: 10 }).width('100%')
    }
    .width('80%').backgroundColor('#1E1E1E').borderRadius(16)
  }
}

// --- è®¾å¤‡ç®¡ç†å¼¹çª— ---
@CustomDialog
struct DeviceManageDialog {
  controller: CustomDialogController;
  @StorageLink('HistoryDevices_JSON') historyJson: string = '[]';
  @State historyDevices: SavedDevice[] = [];

  aboutToAppear() {
    try { this.historyDevices = JSON.parse(this.historyJson); } catch(e) {}
  }

  build() {
    Column() {
      Text("å·²é…å¯¹è®¾å¤‡ç®¡ç†").fontSize(18).fontWeight(FontWeight.Bold).fontColor(Color.White).margin({ top: 20, bottom: 10 })

      List() {
        ForEach(this.historyDevices, (item: SavedDevice, index: number) => {
          ListItem() {
            Row() {
              Column() {
                Text(item.deviceName || "æœªçŸ¥è®¾å¤‡").fontSize(16).fontColor(Color.White)
                Text(item.deviceId).fontSize(12).fontColor('#AAAAAA')
              }.alignItems(HorizontalAlign.Start)
              Blank()

              // åˆ é™¤æŒ‰é’®
              Button("åˆ é™¤").height(28).fontSize(12).backgroundColor('#C62828')
                .onClick(async () => { // æ³¨æ„ async
                  // 1. æ”¹å†…å­˜æ•°ç»„
                  this.historyDevices.splice(index, 1);

                  // 2. è½¬æˆå­—ç¬¦ä¸²
                  const newJson = JSON.stringify(this.historyDevices);

                  // 3. æ›´æ–° AppStorage (UIä¼šè‡ªåŠ¨åˆ·æ–°)
                  this.historyJson = newJson;

                  // 4. ã€æ ¸å¿ƒæŒä¹…åŒ–ã€‘å¼ºåˆ¶å†™å…¥ç£ç›˜
                  await PreferencesUtil.put('HistoryDevices_JSON', newJson);

                  try { promptAction.showToast({ message: 'å·²å–æ¶ˆé…å¯¹' }); } catch(e) {}
                  if (this.historyDevices.length === 0) this.controller.close();
                })
            }
            .width('100%').padding({ left: 15, right: 15, top: 10, bottom: 10 }).border({ width: { bottom: 1 }, color: '#333333' })
          }
        })
      }
      .width('100%').height(this.historyDevices.length > 5 ? 300 : 'auto').constraintSize({ minHeight: 100 })

      Button("å…³ é—­").width('90%').margin({ top: 10, bottom: 20 }).backgroundColor('#333333').fontColor(Color.White)
        .onClick(() => { this.controller.close(); })
    }
    .backgroundColor('#1E1E1E').borderRadius(16).width('90%')
  }
}

// --- ä¸»é¡µé¢ ---
@Component
export struct MyPage {
  @StorageLink('HistoryDevices_JSON') historyJson: string = '[]';
  private userName: string = "ç®¡ç†å‘˜";

  dialogController: CustomDialogController = new CustomDialogController({
    builder: DeviceManageDialog(),
    autoCancel: true, alignment: DialogAlignment.Center, customStyle: true
  });

  logoutController: CustomDialogController = new CustomDialogController({
    builder: LogoutDialog({
      userName: this.userName,
      confirmAction: async () => {
        // 1. æ¸…é™¤å†…å­˜çŠ¶æ€
        AppStorage.setOrCreate('LoginTimestamp', 0);

        // 2. ã€æ ¸å¿ƒæŒä¹…åŒ–ã€‘æ¸…é™¤ç£ç›˜è®°å½•
        await PreferencesUtil.put('LoginTimestamp', 0);

        try { router.replaceUrl({ url: 'pages/LoginPage' }); } catch(e) {}
      }
    }),
    autoCancel: true, alignment: DialogAlignment.Center, customStyle: true
  });

  build() {
    Column() {
      // å¤´éƒ¨
      Column() {
        Text('ðŸ‘¤').fontSize(40).width(80).height(80).textAlign(TextAlign.Center).backgroundColor('#333333').borderRadius(40).margin({ bottom: 10 })
        Text(this.userName).fontSize(20).fontWeight(FontWeight.Bold).fontColor(Color.White)
        Text("ID: 88888888").fontSize(14).fontColor('#AAAAAA').margin({ top: 5 })
      }.width('100%').padding({ top: 50, bottom: 30 }).backgroundColor('#1E1E1E')

      // èœå•
      Column({ space: 15 }) {
        this.MenuButton("ç®¡ç†å·²é…å¯¹è®¾å¤‡", "æŸ¥çœ‹æˆ–ç§»é™¤å·²è¿žæŽ¥è¿‡çš„è“ç‰™é”", '#448AFF', () => {
          let list: SavedDevice[] = [];
          try { list = JSON.parse(this.historyJson); } catch(e) {}
          if (list.length === 0) { try { promptAction.showToast({ message: 'æš‚æ— é…å¯¹è®¾å¤‡' }); } catch(e) {} }
          else { this.dialogController.open(); }
        })
        this.MenuButton("é—¨ç¦å¡è®¾ç½®", "æŸ¥çœ‹å„è®¾å¤‡çš„æŽˆæƒå¡ç‰‡ä¿¡æ¯", '#EF6C00', () => {
          try { router.pushUrl({ url: 'pages/CardManagePage' }); } catch (err) {}
        })
      }.width('100%').layoutWeight(1).padding(20)

      // åº•éƒ¨é€€å‡º
      Button("é€€å‡ºç™»å½•").type(ButtonType.Capsule).width('85%').height(50).backgroundColor('#C62828').fontSize(18).fontWeight(FontWeight.Medium).margin({ bottom: 40 })
        .shadow({ radius: 10, color: '#4D000000', offsetY: 5 })
        .onClick(() => {
          this.logoutController.open();
        })
    }.width('100%').height('100%').backgroundColor('#111111')
  }

  @Builder
  MenuButton(title: string, subtitle: string, color: string, onClick: () => void) {
    Button() {
      Row() {
        Column().width(4).height(40).backgroundColor(color).borderRadius(2).margin({ right: 15 })
        Column() {
          Text(title).fontSize(16).fontWeight(FontWeight.Bold).fontColor(Color.White)
          Text(subtitle).fontSize(12).fontColor('#888888').margin({ top: 4 })
        }.alignItems(HorizontalAlign.Start)
        Blank()
        Text(">").fontSize(16).fontColor('#666666')
      }.width('100%').padding(15)
    }.type(ButtonType.Normal).backgroundColor('#1E1E1E').borderRadius(12).onClick(onClick).shadow({ radius: 4, color: '#000000', offsetY: 2 })
  }
}